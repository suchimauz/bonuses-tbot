(ns tbot.commands
  (:require [morse.api :as t]
            [cheshire.core :as json]
            [clojure.java.io :as io]
            [environ.core :refer [env]]
            [clj-http.client :as http]
            (tbot.resources
             [user :as user])
            (tbot
             [db    :as db]
             [utils :as u])))

(defn start [token {{:keys [username first_name last_name id] :as chat} :chat}]
  (let [db   (db/get-db)
        user (u/get-user-from-chat-id db id)]
    (when-not user
      (u/insert-table
       db user/table
       (merge
        (select-keys chat [:username :first_name :last_name])
        {:chat_id id
         :send_notification false
         :click_url false})))
    (t/send-text token id {:reply_markup (u/reply-markup id "üî• –ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ üî•")}
                 (u/build-msg
                  [["–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, " first_name " üòâ"] []
                   ["–Ø —Ç–≤–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ Jet Casino ü¶æü§ñ"]
                   ["–ù–∞—à–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è üìÉ"]
                   ["–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å–Ω—ã–µ –∞–∫—Ü–∏–∏ üéÅ"]
                   ["cashback –¥–æ 10% ‚ôªÔ∏è"]
                   ["–∞ —Ç–∞–∫–∂–µ —Ç—É—Ä–Ω–∏—Ä—ã –∏ –ª–æ—Ç–µ—Ä–µ–∏ —Å –ø—Ä–∏–∑–æ–≤—ã–º–∏ —Ñ–æ–Ω–¥–∞–º–∏ –≤—ã–≤–µ–ª–∏ –Ω–∞—à–µ –ö–ê–ó–ò–ù–û –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å! üîù"] []
                   ["–ñ–º–∏ –∫–Ω–æ–ø–∫—É \"–ö–†–£–¢–ò–¢–¨ –ö–û–õ–ï–°–û\" –∏ –ø–æ–ª—É—á–∏ –æ—Ç –Ω–∞—Å –î–í–ê —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ü–û–î–ê–†–ö–ê!"]
                   ["–ò—Å–∫—Ä–µ–Ω–Ω–µ –∂–µ–ª–∞–µ–º –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–±–µ–¥ ü™êüèÖ"]
                   ["–∏ –æ–≥—Ä–æ–º–Ω—ã—Ö –≤—ã–∏–≥—Ä—ã—à–µ–π üí∞üí∞üí∞"]]))
    (t/send-text token id {:reply_markup (u/reply-markup id "üéÅ –ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å üéÅ")}
                 (u/build-msg
                  [["–ú—ã —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–ª—è —Ç–µ–±—è –ú–ï–ì–ê-–ö–†–£–¢–´–ï –ë–û–ù–£–°–´ ü•≥ü•≥ü•≥"] []
                   ["–ß—Ç–æ–±—ã –∏—Ö –∑–∞–±—Ä–∞—Ç—å:"]
                   ["1Ô∏è‚É£  –ñ–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚¨áÔ∏è"]
                   ["2Ô∏è‚É£ –°–æ–≤–µ—Ä—à–∏ –ø—Ä–æ—Å—Ç—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚úîÔ∏è"]
                   ["3Ô∏è‚É£ –ü–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å –≤—Å–µ–≥–æ –æ—Ç 200 —Ä—É–±–ª–µ–π –ª—é–±—ã–º –¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º"] []
                   ["–ò –±–æ–Ω—É—Å \"+100% –ö –ü–ï–†–í–û–ú–£ –î–ï–ü–û–ó–ò–¢–£\" –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"]
                   ["–ü–æ–≥–Ω–∞–ª–∏ –ø–æ–±–µ–∂–¥–∞—Ç—å! üòâ"]]))
    (t/send-video
     token id
     {:reply_markup (json/generate-string (u/reply-markup id "–í–ø–µ—Ä–µ–¥ –∑–∞ –ø–æ–±–µ–¥–∞–º–∏ üöÄüèÜ"))
      :duration "112"
      :thumb (io/file "/resources/thumb.jpg")
      :caption "–í–∑–≥–ª—è–Ω–∏ –∫–∞–∫ –ª—é–¥–∏ –ø–æ–±–µ–∂–¥–∞—é—Ç –Ω–∞ –Ω–∞—à–∏—Ö –±–æ–Ω—É—Å–∞—Ö –≤ –≤–∏–¥–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≤—Ä–∞—â–µ–Ω–∏–π ‚ò∫Ô∏è"}
     (io/file "/resources/video.mp4"))))
